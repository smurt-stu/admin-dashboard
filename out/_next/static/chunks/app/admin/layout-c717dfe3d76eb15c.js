(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[581],{66566:(e,t,s)=>{Promise.resolve().then(s.bind(s,91291))},91291:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>d});var o=s(95155),n=s(76046),r=s(48173),l=s.n(r),a=s(12115);function c(){let e=(0,n.usePathname)(),[t,s]=(0,a.useState)(["products"]),r=e=>{s(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},c=t=>e===t,i=t=>t.some(t=>e===t.href);return(0,o.jsx)("div",{className:"w-64 bg-white shadow-lg border-r border-gray-200",children:(0,o.jsxs)("div",{className:"p-6",children:[(0,o.jsxs)("div",{className:"flex items-center space-x-2 mb-8",children:[(0,o.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:(0,o.jsx)("i",{className:"ri-store-2-fill text-white text-lg"})}),(0,o.jsx)("span",{className:"text-xl font-bold text-gray-800",style:{fontFamily:"Pacifico, serif"},children:"متجري"})]}),(0,o.jsx)("nav",{className:"space-y-2",children:[{href:"/admin",icon:"ri-dashboard-fill",label:"لوحة القيادة"},{key:"products",icon:"ri-box-3-fill",label:"إدارة المنتجات",submenu:[{href:"/admin/products",icon:"ri-shopping-bag-line",label:"كل المنتجات"},{href:"/admin/products/create",icon:"ri-add-line",label:"إضافة منتج"},{href:"/admin/categories",icon:"ri-folder-line",label:"إدارة الفئات"}]}].map((e,s)=>{if(e.submenu&&e.key){let s=t.includes(e.key),n=i(e.submenu);return(0,o.jsxs)("div",{children:[(0,o.jsxs)("button",{onClick:()=>r(e.key),className:"w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors whitespace-nowrap ".concat(n?"bg-blue-50 text-blue-600":"text-gray-700 hover:bg-gray-50"),children:[(0,o.jsxs)("div",{className:"flex items-center space-x-3 rtl:space-x-reverse",children:[(0,o.jsx)("i",{className:"".concat(e.icon," text-xl")}),(0,o.jsx)("span",{className:"font-medium",children:e.label})]}),(0,o.jsx)("i",{className:"ri-arrow-".concat(s?"up":"down","-s-line text-sm")})]}),s&&(0,o.jsx)("div",{className:"mt-2 mr-6 space-y-1",children:e.submenu.map(e=>(0,o.jsxs)(l(),{href:e.href,className:"flex items-center space-x-3 rtl:space-x-reverse px-4 py-2 rounded-lg transition-colors whitespace-nowrap cursor-pointer ".concat(c(e.href)?"bg-blue-100 text-blue-700 font-medium":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"),children:[(0,o.jsx)("i",{className:"".concat(e.icon," text-lg")}),(0,o.jsx)("span",{children:e.label})]},e.href))})]},e.key)}return(0,o.jsxs)(l(),{href:e.href,className:"flex items-center space-x-3 rtl:space-x-reverse px-4 py-3 rounded-lg transition-colors whitespace-nowrap cursor-pointer ".concat(c(e.href)?"bg-blue-50 text-blue-600 border-r-4 border-blue-600":"text-gray-700 hover:bg-gray-50"),children:[(0,o.jsx)("i",{className:"".concat(e.icon," text-xl")}),(0,o.jsx)("span",{className:"font-medium",children:e.label})]},e.href||s)})})]})})}var i=s(77139);function h(){let[e,t]=(0,a.useState)(!1),s=(0,n.useRouter)();return(0,o.jsx)("header",{className:"bg-white shadow-sm border-b border-gray-200 px-6 py-4",children:(0,o.jsxs)("div",{className:"flex justify-between items-center",children:[(0,o.jsx)("h1",{className:"text-2xl font-bold text-gray-800",children:"لوحة التحكم"}),(0,o.jsxs)("div",{className:"flex items-center space-x-4 rtl:space-x-reverse",children:[(0,o.jsx)("button",{className:"p-2 text-gray-500 hover:text-gray-700 cursor-pointer",children:(0,o.jsx)("i",{className:"ri-notification-3-line text-xl"})}),(0,o.jsxs)("div",{className:"relative",children:[(0,o.jsxs)("button",{onClick:()=>t(!e),className:"flex items-center space-x-2 rtl:space-x-reverse p-2 rounded-lg hover:bg-gray-50 cursor-pointer",children:[(0,o.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:(0,o.jsx)("i",{className:"ri-user-fill text-white text-sm"})}),(0,o.jsx)("span",{className:"text-gray-700 font-medium",children:"المدير"}),(0,o.jsx)("i",{className:"ri-arrow-down-s-line text-gray-500"})]}),e&&(0,o.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200",children:[(0,o.jsx)(l(),{href:"/admin/profile",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 cursor-pointer",children:"الملف الشخصي"}),(0,o.jsx)(l(),{href:"/admin/settings",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 cursor-pointer",children:"الإعدادات"}),(0,o.jsx)("hr",{className:"my-1"}),(0,o.jsx)(l(),{href:"/",className:"block px-4 py-2 text-gray-700 hover:bg-gray-50 cursor-pointer",children:"العودة للمتجر"}),(0,o.jsx)("button",{onClick:()=>{i.u.removeTokens(),s.push("/admin/login")},className:"block w-full text-right px-4 py-2 text-red-600 hover:bg-red-50 cursor-pointer",children:"تسجيل الخروج"})]})]})]})]})})}function u(e){let{children:t}=e,{isAuthenticated:s,checked:r}=function(){let e=(0,n.useRouter)(),[t,s]=(0,a.useState)(!1),[o,r]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{(async()=>{try{if(console.log("\uD83D\uDD0D [AUTH GUARD] Starting authentication check..."),i.u.debugRawStorage(),i.u.debugTokenStatus(),!i.u.isAuthenticated()){console.log("❌ [AUTH GUARD] No token found, redirecting to login"),s(!1),r(!0),e.push("/admin/login");return}if(console.log("✅ [AUTH GUARD] Token exists, verifying validity..."),!await i.u.verifyToken()){console.log("❌ [AUTH GUARD] Token validation failed, redirecting to login"),s(!1),r(!0),e.push("/admin/login");return}console.log("✅ [AUTH GUARD] Authentication successful"),s(!0),r(!0)}catch(t){console.error("❌ [AUTH GUARD] Auth check failed:",t),s(!1),r(!0),e.push("/admin/login")}})()},[e]),{isAuthenticated:t,checked:o}}();return r?s?(0,o.jsx)(o.Fragment,{children:t}):(0,o.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,o.jsx)("p",{className:"text-gray-600",children:"جاري إعادة التوجيه..."})]})}):(0,o.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,o.jsx)("p",{className:"text-gray-600",children:"جاري التحقق من صلاحية الوصول..."})]})})}function d(e){let{children:t}=e;return"/admin/login"===(0,n.usePathname)()?(0,o.jsx)(o.Fragment,{children:t}):(0,o.jsx)(u,{children:(0,o.jsxs)("div",{className:"flex h-screen bg-gray-50",children:[(0,o.jsx)(c,{}),(0,o.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,o.jsx)(h,{}),(0,o.jsx)("main",{className:"flex-1 overflow-y-auto p-6",children:t})]})]})})}},77139:(e,t,s)=>{"use strict";s.d(t,{u:()=>n});let o="https://smart-ai-api.onrender.com/api/v1";class n{static async login(e){try{var t,s;console.log("\uD83D\uDD10 [AUTH] Starting login process...");let n=await fetch("".concat(o,"/auth/login/"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.message||"بيانات تسجيل الدخول غير صحيحة")}let r=await n.json();return console.log("\uD83D\uDD10 [AUTH] Login successful:",{hasAccessToken:!!r.access,hasRefreshToken:!!r.refresh,accessTokenLength:(null===(t=r.access)||void 0===t?void 0:t.length)||0,refreshTokenLength:(null===(s=r.refresh)||void 0===s?void 0:s.length)||0,userEmail:r.email||"N/A"}),r}catch(e){if(e instanceof Error)throw e;throw Error("حدث خطأ في الاتصال بالخادم")}}static getToken(){{let e=localStorage.getItem("access_token");return"undefined"===e||"null"===e?(console.log("\uD83E\uDDF9 [AUTH] Found corrupted access token, clearing..."),this.removeTokens(),null):(console.log("\uD83D\uDCD6 [AUTH] Retrieved access token:",{exists:!!e,length:(null==e?void 0:e.length)||0,isValid:e&&"undefined"!==e&&"null"!==e}),e)}}static getRefreshToken(){{let e=localStorage.getItem("refresh_token");return"undefined"===e||"null"===e?(console.log("\uD83E\uDDF9 [AUTH] Found corrupted refresh token, clearing..."),this.removeTokens(),null):(console.log("\uD83D\uDCD6 [AUTH] Retrieved refresh token:",{exists:!!e,length:(null==e?void 0:e.length)||0,isValid:e&&"undefined"!==e&&"null"!==e}),e)}}static setTokens(e,t){if(!e||!t||"undefined"===e||"undefined"===t||"null"===e||"null"===t){console.error("❌ [AUTH] Invalid tokens provided, cannot store");return}console.log("\uD83D\uDCBE [AUTH] Setting tokens:",{accessTokenLength:e.length,refreshTokenLength:t.length,accessTokenValid:3===e.split(".").length,refreshTokenValid:3===t.split(".").length}),localStorage.setItem("access_token",e),localStorage.setItem("refresh_token",t),console.log("✅ [AUTH] Tokens stored successfully")}static removeTokens(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}static clearCorruptedTokens(){{let e=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token");("undefined"===e||"undefined"===t||"null"===e||"null"===t)&&(console.log("\uD83E\uDDF9 [AUTH] Clearing corrupted tokens..."),this.removeTokens())}}static debugRawStorage(){{let e=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token");console.log("\uD83D\uDDC4️ [AUTH] Raw localStorage contents:"),console.log("  - Raw access_token:",e),console.log("  - Raw refresh_token:",t),console.log("  - Access token type:",typeof e),console.log("  - Refresh token type:",typeof t)}}static debugTokenStatus(){let e=this.getToken(),t=this.getRefreshToken();if(console.log("\uD83D\uDD0D [AUTH DEBUG] Token Status:"),console.log("  - Access Token: ".concat(e?"Present":"Missing")),console.log("  - Refresh Token: ".concat(t?"Present":"Missing")),e){console.log("  - Access Token Details:",{length:e.length,start:e.substring(0,30),end:e.substring(e.length-10),hasJWTStructure:3===e.split(".").length,parts:e.split(".").length});try{let t=e.split(".");if(3!==t.length)console.log("  - Token is not in JWT format (should have 3 parts separated by dots)");else{let e=t[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")),o=JSON.parse(s),n=Math.floor(Date.now()/1e3),r=o.exp-n;console.log("  - Access Token Expires: ".concat(new Date(1e3*o.exp).toLocaleString())),console.log("  - Time until expiry: ".concat(r," seconds")),console.log("  - Is Expired: ".concat(r<=0))}}catch(e){console.log("  - Could not decode access token:",e)}}if(t){console.log("  - Refresh Token Details:",{length:t.length,start:t.substring(0,30),end:t.substring(t.length-10),hasJWTStructure:3===t.split(".").length,parts:t.split(".").length});try{let e=t.split(".");if(3!==e.length)console.log("  - Refresh token is not in JWT format (should have 3 parts separated by dots)");else{let t=e[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")),o=JSON.parse(s),n=Math.floor(Date.now()/1e3),r=o.exp-n;console.log("  - Refresh Token Expires: ".concat(new Date(1e3*o.exp).toLocaleString())),console.log("  - Time until expiry: ".concat(r," seconds")),console.log("  - Is Expired: ".concat(r<=0))}}catch(e){console.log("  - Could not decode refresh token:",e)}}}static isAuthenticated(){return!!this.getToken()}static async refreshToken(){let e=this.getRefreshToken();if(!e)return console.log("\uD83D\uDD04 [AUTH] No refresh token found"),!1;for(let t of(console.log("\uD83D\uDD04 [AUTH] Attempting to refresh token..."),[{url:"".concat(o,"/auth/token/refresh/"),body:{refresh:e}},{url:"".concat(o,"/auth/refresh/"),body:{refresh:e}},{url:"".concat(o,"/token/refresh/"),body:{refresh:e}},{url:"".concat(o,"/auth/jwt/refresh/"),body:{refresh:e}}]))try{console.log("\uD83D\uDD04 [AUTH] Trying refresh endpoint: ".concat(t.url)),console.log("\uD83D\uDD04 [AUTH] Request body:",t.body);let s=await fetch(t.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.body)});if(console.log("\uD83D\uDD04 [AUTH] Response status: ".concat(s.status)),s.ok){let t=await s.json();if(console.log("✅ [AUTH] Token refresh successful"),t.access&&t.refresh)this.setTokens(t.access,t.refresh);else if(t.access_token&&t.refresh_token)this.setTokens(t.access_token,t.refresh_token);else if(t.access)this.setTokens(t.access,e);else if(t.access_token)this.setTokens(t.access_token,e);else{console.error("\uD83D\uDD04 [AUTH] Unexpected response format:",t);continue}return!0}{let e=await s.json().catch(()=>({}));console.log("❌ [AUTH] Refresh failed with status ".concat(s.status,":"),e)}}catch(e){console.log("❌ [AUTH] Refresh attempt failed:",e)}return console.log("❌ [AUTH] All refresh attempts failed, removing tokens"),this.removeTokens(),!1}static async verifyToken(){let e=this.getToken();if(!e)return console.log("\uD83D\uDD0D [AUTH] No access token found"),!1;try{console.log("\uD83D\uDD0D [AUTH] Verifying access token...");let t=await fetch("".concat(o,"/auth/profile/"),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(console.log("\uD83D\uDD0D [AUTH] Token verification response: ".concat(t.status)),401===t.status){if(console.log("\uD83D\uDD04 [AUTH] Access token expired, attempting refresh..."),await this.refreshToken()){console.log("✅ [AUTH] Token refreshed, retrying verification...");let e=this.getToken();if(e){let t=(await fetch("".concat(o,"/auth/profile/"),{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}})).ok;return console.log("\uD83D\uDD0D [AUTH] Retry verification result: ".concat(t)),t}}return console.log("❌ [AUTH] Token refresh failed, removing tokens"),this.removeTokens(),!1}let s=t.ok;return console.log("✅ [AUTH] Token verification result: ".concat(s)),s}catch(e){return console.log("⚠️ [AUTH] Network error during token verification:",e),!0}}static logout(){this.removeTokens(),window.location.href="/admin/login"}static async makeAuthenticatedRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=this.getToken();if(!s)throw Error("لم يتم تسجيل الدخول");let o=await fetch(e,{...t,headers:{...t.headers,Authorization:"Bearer ".concat(s),"Content-Type":"application/json"}});if(401===o.status){if(await this.refreshToken()){if(s=this.getToken()){if(401===(o=await fetch(e,{...t,headers:{...t.headers,Authorization:"Bearer ".concat(s),"Content-Type":"application/json"}})).status)throw this.logout(),Error("انتهت صلاحية الجلسة")}else throw this.logout(),Error("انتهت صلاحية الجلسة")}else throw this.logout(),Error("انتهت صلاحية الجلسة")}return o}}},76046:(e,t,s)=>{"use strict";var o=s(66658);s.o(o,"usePathname")&&s.d(t,{usePathname:function(){return o.usePathname}}),s.o(o,"useRouter")&&s.d(t,{useRouter:function(){return o.useRouter}})}},e=>{var t=t=>e(e.s=t);e.O(0,[173,441,517,358],()=>t(66566)),_N_E=e.O()}]);